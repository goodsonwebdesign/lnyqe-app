<div class="container mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8">
  <div class="mb-4 flex justify-end">
    <app-button (click)="exitProfile()" variant="secondary" data-testid="exit-profile-button">
      Back to Dashboard
    </app-button>
  </div>
  <div class="mx-auto max-w-4xl">
    <h1 class="mb-6 text-2xl font-bold text-neutral-800 dark:text-neutral-200">User Preferences</h1>

    <!-- User Profile Section -->
    <div class="mb-6 rounded-lg bg-white p-6 shadow dark:bg-neutral-800">
      <h2 class="mb-4 text-xl font-semibold text-neutral-700 dark:text-neutral-300">
        Profile Information
      </h2>

      <ng-container *ngIf="user; else loadingUser">
        <div class="flex items-start space-x-4">
          <!-- User Avatar -->
          <div class="flex-shrink-0">
            <img
              *ngIf="user.avatar; else initialsAvatar"
              [src]="user.avatar"
              [alt]="user.name + ' avatar'"
              class="h-20 w-20 rounded-full object-cover"
              data-testid="user-avatar-img"
            />
            <ng-template #initialsAvatar>
              <div
                class="flex h-20 w-20 items-center justify-center rounded-full bg-primary-100 text-2xl font-bold text-primary-700 dark:bg-primary-900 dark:text-primary-300"
                [attr.aria-label]="(user.name || 'User') + ' avatar'"
                data-testid="user-avatar-initials"
              >
                {{ (user.name || 'U').charAt(0).toUpperCase() }}
              </div>
            </ng-template>
          </div>

          <!-- User Details Form -->
          <ng-container *ngIf="isEditing; else displayView">
            <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="flex-grow space-y-4">
            <div>
              <label for="first_name" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">First Name</label>
              <input type="text" id="first_name" formControlName="first_name" class="mt-1 block w-full rounded-md border-neutral-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-neutral-600 dark:bg-neutral-700 dark:text-white sm:text-sm" />
              <div *ngIf="userForm.get('first_name')?.invalid && (userForm.get('first_name')?.dirty || userForm.get('first_name')?.touched)" class="mt-1 text-sm text-red-600 dark:text-red-400">
                <small *ngIf="userForm.get('first_name')?.errors?.['required']">First name is required.</small>
              </div>
            </div>

            <div>
              <label for="last_name" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">Last Name</label>
              <input type="text" id="last_name" formControlName="last_name" class="mt-1 block w-full rounded-md border-neutral-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-neutral-600 dark:bg-neutral-700 dark:text-white sm:text-sm" />
              <div *ngIf="userForm.get('last_name')?.invalid && (userForm.get('last_name')?.dirty || userForm.get('last_name')?.touched)" class="mt-1 text-sm text-red-600 dark:text-red-400">
                <small *ngIf="userForm.get('last_name')?.errors?.['required']">Last name is required.</small>
              </div>
            </div>

            <div>
              <label for="email" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">Email</label>
              <input type="email" id="email" formControlName="email" class="mt-1 block w-full rounded-md border-neutral-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:border-neutral-600 dark:bg-neutral-700 dark:text-white sm:text-sm" />
              <div *ngIf="userForm.get('email')?.invalid && (userForm.get('email')?.dirty || userForm.get('email')?.touched)" class="mt-1 text-sm text-red-600 dark:text-red-400">
                <small *ngIf="userForm.get('email')?.errors?.['required']">Email is required.</small>
                <small *ngIf="userForm.get('email')?.errors?.['email']">Please enter a valid email address.</small>
              </div>
            </div>

            <div class="flex justify-end pt-4 space-x-2">
              <app-button
                type="button"
                (click)="cancelEdit()"
                variant="secondary"
              >
                Cancel
              </app-button>
              <app-button
                type="submit"
                [disabled]="!userForm.valid || !userForm.dirty"
                variant="primary"
                data-testid="save-profile-button"
              >
                Save Changes
              </app-button>
            </div>
          </form>
        </ng-container>

        <ng-template #displayView>
            <div class="flex-grow space-y-4">
              <div>
                <h3 class="text-sm font-medium text-neutral-500 dark:text-neutral-400">First Name</h3>
                <p class="mt-1 text-neutral-900 dark:text-white">{{ user.first_name }}</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-neutral-500 dark:text-neutral-400">Last Name</h3>
                <p class="mt-1 text-neutral-900 dark:text-white">{{ user.last_name }}</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-neutral-500 dark:text-neutral-400">Email</h3>
                <p class="mt-1 text-neutral-900 dark:text-white">{{ user.email }}</p>
              </div>
              <div class="flex justify-end pt-4">
                <app-button
                  (click)="startEditing()"
                  variant="primary"
                  data-testid="edit-profile-button"
                >
                  Edit Profile
                </app-button>
              </div>
            </div>
          </ng-template>
        </div>
      </ng-container>

      <ng-template #loadingUser>
        <p class="text-neutral-500 dark:text-neutral-400">Loading user information...</p>
      </ng-template>
    </div>

    <!-- App Settings Section -->
    <div class="mb-6 rounded-lg bg-white p-6 shadow dark:bg-neutral-800">
      <h2 class="mb-4 text-xl font-semibold text-neutral-700 dark:text-neutral-300">
        Application Settings
      </h2>

      <!-- Theme Dropdown -->
      <div
        class="flex items-center justify-between border-b border-neutral-200 py-3 dark:border-neutral-700"
      >
        <div>
          <h3 class="font-medium text-neutral-900 dark:text-white">Theme Preference</h3>
          <p class="text-sm text-neutral-500 dark:text-neutral-400">
            Choose between light, dark, or system theme
          </p>
        </div>
        <div class="flex items-center">
          <select
            [ngModel]="currentTheme"
            (change)="changeTheme($event)"
            class="block w-48 rounded-md border-0 bg-white py-1.5 pl-3 pr-10 text-neutral-900 shadow-sm ring-1 ring-inset ring-neutral-300 focus:ring-2 focus:ring-inset focus:ring-primary-500 dark:bg-neutral-700 dark:text-white dark:ring-neutral-600 sm:text-sm focus:outline-none"
            aria-label="Select theme preference"
            data-testid="theme-select"
          >
            <option *ngFor="let option of themeOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>
      </div>

      <!-- Other settings can be added here as needed -->
    </div>

    <!-- Notification Preferences (Placeholder for future implementation) -->
    <div class="rounded-lg bg-white p-6 shadow dark:bg-neutral-800">
      <h2 class="mb-4 text-xl font-semibold text-neutral-700 dark:text-neutral-300">
        Notification Preferences
      </h2>
      <p class="text-neutral-500 dark:text-neutral-400">
        Notification preferences will be available in a future update.
      </p>
    </div>
  </div>
</div>
