<div class="relative" (clickOutside)="closeMenu()">
  <!-- Avatar/User Icon Button -->
  <button
    type="button"
    class="relative rounded-full p-1 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-primary-500"
    [ngClass]="{'bg-neutral-200 dark:bg-neutral-700': isLoggedIn, 'bg-primary-50 dark:bg-primary-900 text-primary-700 dark:text-primary-300': !isLoggedIn}"
    (click)="toggleMenu()"
    aria-label="User menu"
  >
    <!-- User icon when not logged in -->
    <svg
      *ngIf="!isLoggedIn"
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
      />
    </svg>

    <!-- User avatar if available -->
    <img
      *ngIf="isLoggedIn && user?.picture"
      [src]="user.picture"
      [alt]="user.name"
      class="h-6 w-6 rounded-full"
    >

    <!-- User initials when logged in but no picture -->
    <div
      *ngIf="isLoggedIn && !user?.picture"
      class="text-sm font-medium h-6 w-6 rounded-full flex items-center justify-center text-neutral-700 dark:text-neutral-200"
    >
      {{ getUserInitials() }}
    </div>
  </button>

  <!-- Dropdown Menu -->
  <div
    *ngIf="isMenuOpen"
    class="absolute right-0 mt-2 w-56 origin-top-right rounded-md shadow-lg py-1 bg-white dark:bg-neutral-800 ring-1 ring-black ring-opacity-5 z-50"
  >
    <!-- Not logged in menu -->
    <div *ngIf="!isLoggedIn">
      <a
        class="block px-4 py-2 text-sm text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-700 cursor-pointer"
        (click)="login()"
      >
        Log In
      </a>
      <a
        class="block px-4 py-2 text-sm text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-700 cursor-pointer"
        (click)="login()"
      >
        Sign Up
      </a>
    </div>

    <!-- Logged in menu -->
    <div *ngIf="isLoggedIn">
      <div class="block px-4 py-2 text-sm text-neutral-500 dark:text-neutral-400 border-b border-neutral-200 dark:border-neutral-700">
        Signed in as <span class="font-medium text-neutral-900 dark:text-neutral-200">{{ user?.name || user?.email }}</span>
      </div>
      <a
        class="block px-4 py-2 text-sm text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-700 cursor-pointer"
        routerLink="/preferences"
        (click)="closeMenu()"
      >
        Preferences
      </a>
      <a
        class="block px-4 py-2 text-sm text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-700 cursor-pointer"
        (click)="logout()"
      >
        Sign Out
      </a>
    </div>
  </div>
</div>
